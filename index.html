<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HACCP Dokumentations-Tool - Pflegeheim</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #34495e;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: #d5dbdb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #e74c3c;
        }
        
        .card h2 {
            color: #c0392b;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .temp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .temp-card {
            background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #27ae60;
        }
        
        .temp-card.critical {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-left-color: #f39c12;
        }
        
        .temp-card.danger {
            background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%);
            border-left-color: #e74c3c;
        }
        
        .temp-card h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .temp-card.critical h3 {
            color: #f39c12;
        }
        
        .temp-card.danger h3 {
            color: #e74c3c;
        }
        
        .temp-input-group {
            display: grid;
            grid-template-columns: 1fr 100px 80px;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .temp-input-group label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .temp-input-group input {
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .temp-input-group input:focus {
            outline: none;
            border-color: #e74c3c;
        }
        
        .temp-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
        }
        
        .status-ok {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }
        
        .checklist {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .checklist h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .check-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #95a5a6;
        }
        
        .check-item.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .check-item.failed {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .check-item input[type="checkbox"] {
            margin-right: 15px;
            transform: scale(1.2);
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }
        
        .check-item label {
            flex: 1;
            cursor: pointer;
            margin-right: 10px; /* Space between label and timestamp */
        }
        
        .check-item .timestamp {
            font-size: 0.9em;
            color: #6c757d;
            margin-right: 10px; /* Space between timestamp and responsible */
            white-space: nowrap; /* Prevent line break */
        }

        .check-item .responsible-display {
            font-size: 0.9em;
            color: #34495e;
            font-weight: bold;
            margin-right: 5px;
            white-space: nowrap;
        }

        .check-item .responsible-input {
            padding: 5px 8px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 0.9em;
            width: 80px; /* Fixed width for input */
            flex-shrink: 0;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .summary-box h3 {
            margin-bottom: 15px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        .corrective-action {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .corrective-action h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .protocol-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .protocol-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .protocol-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top; /* Align cell content to top */
        }
        
        .protocol-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .protocol-table tr:hover {
            background-color: #e8f4f8;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #34495e;
            color: white;
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .temp-input-group {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .temp-grid {
                grid-template-columns: 1fr;
            }

            .check-item {
                flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            }

            .check-item label {
                flex-basis: 100%; /* Make label take full width */
                margin-bottom: 5px;
            }

            .check-item .timestamp, .check-item .responsible-display, .check-item .responsible-input {
                margin-top: 5px;
                margin-left: 0;
                width: auto; /* Allow auto width for flexible content */
            }
        }
        @media print {
            body { 
                -webkit-print-color-adjust: exact !important; 
                color-adjust: exact !important;
                margin: 20px; 
                font-size: 10pt; 
            }
            .header { 
                background: #e74c3c !important; /* Force background color */
                color: white !important; 
                padding: 15px; 
                border-radius: 8px; 
                text-align: center; 
                margin-bottom: 20px; 
                box-shadow: none; 
            }
            .card { 
                box-shadow: none; 
                border: 1px solid #ccc; 
                margin-bottom: 15px; 
                padding: 15px; 
                border-left: 5px solid #e74c3c; 
            }
            .protocol-table { 
                width: 100%; 
                border-collapse: collapse; 
                margin: 15px 0; 
            }
            .protocol-table th, .protocol-table td { 
                border: 1px solid #ddd; 
                padding: 8px; 
                text-align: left; 
            }
            .protocol-table th { 
                background: #34495e !important; /* Force background color */
                color: white !important; 
            }
            .summary-box { 
                background: #0984e3 !important; /* Force background color */
                color: white !important; 
                padding: 15px; 
                border-radius: 8px; 
                margin: 15px 0; 
            }
            .summary-stats { 
                display: flex; 
                flex-wrap: wrap; 
                justify-content: space-around; 
                gap: 10px; 
            }
            .stat-item { 
                background: rgba(255,255,255,0.2) !important; /* Force background color */
                padding: 10px; 
                border-radius: 5px; 
                flex: 1; 
                min-width: 120px; 
                text-align: center; 
            }
            /* Hide elements not relevant for printing */
            .nav-tabs, .btn, .footer { display: none !important; }
            /* Ensure text is readable */
            .protocol-table td { color: #000; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è HACCP Dokumentations-Tool</h1>
            <p>Hazard Analysis Critical Control Points - K√ºchenhygiene Pflegeheim</p>
            <p><strong>Datum:</strong> <span id="currentDate"></span> | <strong>Schicht:</strong> <span id="currentShift"></span></p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('temperatures')">üå°Ô∏è Temperaturen</button>
            <button class="nav-tab" onclick="switchTab('hygiene')">üßº Hygiene</button>
            <button class="nav-tab" onclick="switchTab('storage')">üì¶ Lagerung</button>
            <button class="nav-tab" onclick="switchTab('cleaning')">üßΩ Reinigung</button>
            <button class="nav-tab" onclick="switchTab('protocols')">üìã Protokolle</button>
        </div>

        <div id="temperatures" class="tab-content active">
            <div class="card">
                <h2>üå°Ô∏è Temperaturkontrolle</h2>
                <div class="temp-grid">
                    <div class="temp-card">
                        <h3>‚ùÑÔ∏è K√ºhlschrank Allgemein</h3>
                        <p><strong>Sollwert:</strong> 2¬∞C bis 7¬∞C</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="fridge-temp" step="0.1" placeholder="z.B. 4.2" onchange="checkTemperature('fridge', this.value, 2, 7)">
                            <div id="fridge-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="fridge-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card">
                        <h3>üßä Tiefk√ºhlung</h3>
                        <p><strong>Sollwert:</strong> -18¬∞C oder k√§lter</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="freezer-temp" step="0.1" placeholder="z.B. -20.5" onchange="checkTemperature('freezer', this.value, -30, -18)">
                            <div id="freezer-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="freezer-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card critical">
                        <h3>üî• Warmhaltung</h3>
                        <p><strong>Sollwert:</strong> mindestens 65¬∞C</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="warmer-temp" step="0.1" placeholder="z.B. 68.0" onchange="checkTemperature('warmer', this.value, 65, 100)">
                            <div id="warmer-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="warmer-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card critical">
                        <h3>üç≤ Speisen beim Servieren</h3>
                        <p><strong>Sollwert:</strong> mindestens 65¬∞C (warm) / max. 7¬∞C (kalt)</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="serving-temp" step="0.1" placeholder="z.B. 67.5" onchange="checkServingTemperature(this.value)">
                            <div id="serving-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Art der Speise:</label>
                            <select id="serving-type" onchange="checkServingTemperature(document.getElementById('serving-temp').value)">
                                <option value="warm">Warme Speise</option>
                                <option value="cold">Kalte Speise</option>
                            </select>
                            <div></div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="serving-time">
                            <div></div>
                        </div>
                    </div>
                </div>

                <div class="corrective-action" id="temp-corrective" style="display: none;">
                    <h4>‚ö†Ô∏è Korrekturma√ünahmen erforderlich</h4>
                    <div class="input-group">
                        <label for="temp-action">Durchgef√ºhrte Ma√ünahmen:</label>
                        <textarea id="temp-action" rows="3" placeholder="z.B. K√ºhlung √ºberpr√ºft, Service informiert, Speisen nacherhitzt..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="temp-responsible">Verantwortlicher Mitarbeiter:</label>
                        <input type="text" id="temp-responsible" placeholder="Name des Mitarbeiters">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveTemperatures()">üíæ Temperaturen speichern</button>
            </div>
        </div>

        <div id="hygiene" class="tab-content">
            <div class="card">
                <h2>üßº Hygienecheckliste</h2>
                
                <div class="checklist">
                    <h3>üë• Personalhygiene</h3>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-hands" onchange="updateCheckItem(this)">
                        <label for="hygiene-hands">H√§ndewaschen und Desinfektion vor Arbeitsbeginn</label>
                        <span class="timestamp" id="hygiene-hands-time"></span>
                        <span class="responsible-display" id="hygiene-hands-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-hands-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-clothing" onchange="updateCheckItem(this)">
                        <label for="hygiene-clothing">Saubere Arbeitskleidung und Kopfbedeckung</label>
                        <span class="timestamp" id="hygiene-clothing-time"></span>
                        <span class="responsible-display" id="hygiene-clothing-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-clothing-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-wounds" onchange="updateCheckItem(this)">
                        <label for="hygiene-wounds">Wunden und Verletzungen ordnungsgem√§√ü abgedeckt</label>
                        <span class="timestamp" id="hygiene-wounds-time"></span>
                        <span class="responsible-display" id="hygiene-wounds-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-wounds-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-jewelry" onchange="updateCheckItem(this)">
                        <label for="hygiene-jewelry">Schmuck abgelegt (au√üer Ehering)</label>
                        <span class="timestamp" id="hygiene-jewelry-time"></span>
                        <span class="responsible-display" id="hygiene-jewelry-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-jewelry-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <div class="checklist">
                    <h3>üçΩÔ∏è Lebensmittelhygiene</h3>
                    <div class="check-item">
                        <input type="checkbox" id="food-separation" onchange="updateCheckItem(this)">
                        <label for="food-separation">Rohe und gegarte Lebensmittel getrennt verarbeitet</label>
                        <span class="timestamp" id="food-separation-time"></span>
                        <span class="responsible-display" id="food-separation-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-separation-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="food-boards" onchange="updateCheckItem(this)">
                        <label for="food-boards">Verschiedene Schneidebretter f√ºr verschiedene Lebensmittel</label>
                        <span class="timestamp" id="food-boards-time"></span>
                        <span class="responsible-display" id="food-boards-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-boards-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="food-storage" onchange="updateCheckItem(this)">
                        <label for="food-storage">Lebensmittel ordnungsgem√§√ü gelagert und abgedeckt</label>
                        <span class="timestamp" id="food-storage-time"></span>
                        <span class="responsible-display" id="food-storage-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-storage-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="food-dates" onchange="updateCheckItem(this)">
                        <label for="food-dates">Verfallsdaten √ºberpr√ºft und dokumentiert</label>
                        <span class="timestamp" id="food-dates-time"></span>
                        <span class="responsible-display" id="food-dates-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-dates-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <div class="checklist">
                    <h3>üßΩ Arbeitspl√§tze und Ger√§te</h3>
                    <div class="check-item">
                        <input type="checkbox" id="work-surfaces" onchange="updateCheckItem(this)">
                        <label for="work-surfaces">Arbeitsfl√§chen gereinigt und desinfiziert</label>
                        <span class="timestamp" id="work-surfaces-time"></span>
                        <span class="responsible-display" id="work-surfaces-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="work-surfaces-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="equipment-clean" onchange="updateCheckItem(this)">
                        <label for="equipment-clean">Ger√§te und Maschinen nach Gebrauch gereinigt</label>
                        <span class="timestamp" id="equipment-clean-time"></span>
                        <span class="responsible-display" id="equipment-clean-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="equipment-clean-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="utensils-clean" onchange="updateCheckItem(this)">
                        <label for="utensils-clean">K√ºchenutensilien sauber und in gutem Zustand</label>
                        <span class="timestamp" id="utensils-clean-time"></span>
                        <span class="responsible-display" id="utensils-clean-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="utensils-clean-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="waste-disposal" onchange="updateCheckItem(this)">
                        <label for="waste-disposal">Abfallbeh√§lter entleert und gereinigt</label>
                        <span class="timestamp" id="waste-disposal-time"></span>
                        <span class="responsible-display" id="waste-disposal-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="waste-disposal-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="pest-control" onchange="updateCheckItem(this)">
                        <label for="pest-control">Keine Anzeichen von Sch√§dlingsbefall</label>
                        <span class="timestamp" id="pest-control-time"></span>
                        <span class="responsible-display" id="pest-control-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="pest-control-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveHygieneChecks()">üíæ Hygienechecks speichern</button>
            </div>
        </div>

        <div id="storage" class="tab-content">
            <div class="card">
                <h2>üì¶ Lagerung</h2>
                <div class="checklist">
                    <h3>‚úîÔ∏è Wareneingang und Lagerhaltung</h3>
                    <div class="check-item">
                        <input type="checkbox" id="delivery-check" onchange="updateCheckItem(this)">
                        <label for="delivery-check">Lieferung √ºberpr√ºft (Temperatur, Unversehrtheit)</label>
                        <span class="timestamp" id="delivery-check-time"></span>
                        <span class="responsible-display" id="delivery-check-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="delivery-check-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="storage-order" onchange="updateCheckItem(this)">
                        <label for="storage-order">Lebensmittel nach 'First-in, First-out' Prinzip gelagert</label>
                        <span class="timestamp" id="storage-order-time"></span>
                        <span class="responsible-display" id="storage-order-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="storage-order-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="packaging-intact" onchange="updateCheckItem(this)">
                        <label for="packaging-intact">Verpackungen intakt und sauber</label>
                        <span class="timestamp" id="packaging-intact-time"></span>
                        <span class="responsible-display" id="packaging-intact-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="packaging-intact-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="dry-storage-clean" onchange="updateCheckItem(this)">
                        <label for="dry-storage-clean">Trockenlager sauber und ordentlich</label>
                        <span class="timestamp" id="dry-storage-clean-time"></span>
                        <span class="responsible-display" id="dry-storage-clean-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="dry-storage-clean-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="cross-contamination" onchange="updateCheckItem(this)">
                        <label for="cross-contamination">Keine Kreuzkontamination zwischen Produkten</label>
                        <span class="timestamp" id="cross-contamination-time"></span>
                        <span class="responsible-display" id="cross-contamination-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="cross-contamination-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>
                <div class="input-group">
                    <label for="storage-notes">Bemerkungen zur Lagerung:</label>
                    <textarea id="storage-notes" rows="3" placeholder="Besondere Vorkommnisse oder Beobachtungen..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveStorageChecks()">üíæ Lagerung speichern</button>
            </div>
        </div>

        <div id="cleaning" class="tab-content">
            <div class="card">
                <h2>üßΩ Reinigungsplan</h2>
                <div class="checklist">
                    <h3>T√§gliche Reinigung</h3>
                    <div class="check-item">
                        <input type="checkbox" id="clean-daily-surfaces" onchange="updateCheckItem(this)">
                        <label for="clean-daily-surfaces">Arbeitsfl√§chen und Sp√ºlbecken</label>
                        <span class="timestamp" id="clean-daily-surfaces-time"></span>
                        <span class="responsible-display" id="clean-daily-surfaces-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="clean-daily-surfaces-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="clean-daily-floors" onchange="updateCheckItem(this)">
                        <label for="clean-daily-floors">Fu√üb√∂den feucht wischen</label>
                        <span class="timestamp" id="clean-daily-floors-time"></span>
                        <span class="responsible-display" id="clean-daily-floors-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="clean-daily-floors-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="clean-daily-waste" onchange="updateCheckItem(this)">
                        <label for="clean-daily-waste">M√ºlleimer leeren und reinigen</label>
                        <span class="timestamp" id="clean-daily-waste-time"></span>
                        <span class="responsible-display" id="clean-daily-waste-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="clean-daily-waste-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>
                <div class="checklist">
                    <h3>W√∂chentliche Reinigung</h3>
                    <div class="check-item">
                        <input type="checkbox" id="clean-weekly-fridge" onchange="updateCheckItem(this)">
                        <label for="clean-weekly-fridge">K√ºhlschr√§nke und Tiefk√ºhler innen reinigen</label>
                        <span class="timestamp" id="clean-weekly-fridge-time"></span>
                        <span class="responsible-display" id="clean-weekly-fridge-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="clean-weekly-fridge-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="clean-weekly-oven" onchange="updateCheckItem(this)">
                        <label for="clean-weekly-oven">√ñfen und Herde gr√ºndlich reinigen</label>
                        <span class="timestamp" id="clean-weekly-oven-time"></span>
                        <span class="responsible-display" id="clean-weekly-oven-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="clean-weekly-oven-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="clean-weekly-storage" onchange="updateCheckItem(this)">
                        <label for="clean-weekly-storage">Trockenlager saugen/wischen</label>
                        <span class="timestamp" id="clean-weekly-storage-time"></span>
                        <span class="responsible-display" id="clean-weekly-storage-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="clean-weekly-storage-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>
                <div class="input-group">
                    <label for="cleaning-notes">Bemerkungen zur Reinigung:</label>
                    <textarea id="cleaning-notes" rows="3" placeholder="Zus√§tzliche Reinigungsarbeiten, besondere Auff√§lligkeiten..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveCleaningChecks()">üíæ Reinigung speichern</button>
            </div>
        </div>

        <div id="protocols" class="tab-content">
            <div class="card">
                <h2>üìã Protokolle und Verlauf</h2>
                <div class="summary-box">
                    <h3>Tages√ºbersicht</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="temp-ok-count">0</span>
                            <span>Temp. OK</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="temp-warning-count">0</span>
                            <span>Temp. Warnung</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="temp-critical-count">0</span>
                            <span>Temp. Kritisch</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="hygiene-completed-count">0</span>
                            <span>Hygiene erledigt</span>
                        </div>
                    </div>
                </div>

                <h3>Verlauf der letzten Eintr√§ge</h3>
                <table class="protocol-table">
                    <thead>
                        <tr>
                            <th>Datum/Uhrzeit</th>
                            <th>Bereich</th>
                            <th>Messwert/Check</th>
                            <th>Status/Ergebnis</th>
                            <th>Ma√ünahme</th>
                            <th>Verantwortlicher</th>
                        </tr>
                    </thead>
                    <tbody id="protocol-body">
                        </tbody>
                </table>
                <button class="btn btn-success" onclick="printDailyProtocol()">üñ®Ô∏è Tagesprotokoll drucken</button>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 HACCP Dokumentations-Tool f√ºr Pflegeheime</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            updateDateTime();
            // Optional: Set a default shift based on current time
            const now = new Date();
            const hour = now.getHours();
            let shift = '';
            if (hour >= 6 && hour < 14) {
                shift = 'Fr√ºhschicht';
            } else if (hour >= 14 && hour < 22) {
                shift = 'Sp√§tschicht';
            } else {
                shift = 'Nachtschicht';
            }
            document.getElementById('currentShift').textContent = shift;
            loadSavedData(); // Load data AFTER shift is set
        });

        function updateDateTime() {
            const now = new Date();
            const optionsDate = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('de-DE', optionsDate);
        }

        let tempReadings = []; // To store temperature data
        let hygieneChecks = {}; // To store hygiene checklist data
        let storageChecks = {}; // To store storage checklist data
        let cleaningChecks = {}; // To store cleaning checklist data

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.nav-tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }

        function checkTemperature(idPrefix, value, min, max) {
            const temp = parseFloat(value);
            const statusElement = document.getElementById(`${idPrefix}-status`);
            const tempCard = statusElement.closest('.temp-card');
            const correctiveActionDiv = document.getElementById('temp-corrective');
            
            statusElement.className = 'temp-status'; // Reset classes
            // Reset card color classes by removing critical/danger, then re-add if needed
            tempCard.classList.remove('critical', 'danger'); 
            if (idPrefix === 'warmer' || idPrefix === 'serving') {
                tempCard.classList.add('critical'); // Always start with critical color for these
            }

            if (isNaN(temp)) {
                statusElement.textContent = '-';
                updateCorrectiveActionDisplay(); // Check overall status
                return;
            }

            if (idPrefix === 'warmer') { // Warm holding
                if (temp >= min) { // Only check if >= min for warm holding
                    statusElement.textContent = 'OK';
                    statusElement.classList.add('status-ok');
                } else {
                    statusElement.textContent = 'Kritisch! (<65¬∞C)';
                    statusElement.classList.add('status-critical');
                    tempCard.classList.add('danger');
                }
            } else if (idPrefix === 'freezer') { // Freezer
                if (temp <= max) { 
                    statusElement.textContent = 'OK';
                    statusElement.classList.add('status-ok');
                } else if (temp > max && temp <= -10) { // Example warning range between -18 and -10
                    statusElement.textContent = 'Warnung!';
                    statusElement.classList.add('status-warning');
                    tempCard.classList.add('critical');
                } else { // Warmer than -10 or above 0
                    statusElement.textContent = 'Kritisch!';
                    statusElement.classList.add('status-critical');
                    tempCard.classList.add('danger');
                }
            } else { // Fridge (standard min/max for 2-7¬∞C)
                if (temp >= min && temp <= max) {
                    statusElement.textContent = 'OK';
                    statusElement.classList.add('status-ok');
                } else if (temp < min || temp > max) {
                    statusElement.textContent = 'Kritisch!';
                    statusElement.classList.add('status-critical');
                    tempCard.classList.add('danger');
                }
            }
            updateCorrectiveActionDisplay(); // Check overall status
        }

        function checkServingTemperature(value) {
            const temp = parseFloat(value);
            const type = document.getElementById('serving-type').value;
            const statusElement = document.getElementById('serving-status');
            const tempCard = statusElement.closest('.temp-card');
            
            statusElement.className = 'temp-status'; // Reset classes
            tempCard.classList.remove('critical', 'danger'); // Reset card color classes
            tempCard.classList.add('critical'); // Always start with critical color for serving

            if (isNaN(temp)) {
                statusElement.textContent = '-';
                updateCorrectiveActionDisplay(); // Check overall status
                return;
            }

            if (type === 'warm') {
                if (temp >= 65) {
                    statusElement.textContent = 'OK';
                    statusElement.classList.add('status-ok');
                } else {
                    statusElement.textContent = 'Kritisch! (<65¬∞C)';
                    statusElement.classList.add('status-critical');
                    tempCard.classList.add('danger');
                }
            } else if (type === 'cold') {
                if (temp <= 7) {
                    statusElement.textContent = 'OK';
                    statusElement.classList.add('status-ok');
                } else {
                    statusElement.textContent = 'Kritisch! (>7¬∞C)';
                    statusElement.classList.add('status-critical');
                    tempCard.classList.add('danger');
                }
            }
            updateCorrectiveActionDisplay(); // Check overall status
        }

        function updateCorrectiveActionDisplay() {
            const correctiveActionDiv = document.getElementById('temp-corrective');
            const statusElements = ['fridge-status', 'freezer-status', 'warmer-status', 'serving-status'];
            const anyCriticalOrWarning = statusElements.some(id => {
                const element = document.getElementById(id);
                return element && (element.classList.contains('status-critical') || element.classList.contains('status-warning'));
            });

            if (anyCriticalOrWarning) {
                correctiveActionDiv.style.display = 'block';
            } else {
                correctiveActionDiv.style.display = 'none';
            }
        }


        function updateCheckItem(checkbox) {
            const parent = checkbox.closest('.check-item');
            const timestampSpan = parent.querySelector('.timestamp');
            const responsibleInput = parent.querySelector('.responsible-input');
            const responsibleDisplay = parent.querySelector('.responsible-display');
            const responsibleNameSpan = responsibleDisplay ? responsibleDisplay.querySelector('.responsible-name') : null;

            if (checkbox.checked) {
                parent.classList.add('completed');
                parent.classList.remove('failed');
                timestampSpan.textContent = `Erledigt um: ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`;
                
                if (responsibleInput) {
                    responsibleInput.style.display = 'inline-block';
                    // If a name was already set (e.g., from loading saved data), put it back in the input
                    if (responsibleNameSpan && responsibleNameSpan.textContent) {
                        responsibleInput.value = responsibleNameSpan.textContent;
                    }
                    responsibleInput.focus(); // Focus on the input when checked
                }
                if (responsibleDisplay) {
                    responsibleDisplay.style.display = 'none'; // Hide display span when input is active
                }

            } else {
                parent.classList.remove('completed');
                parent.classList.remove('failed'); 
                timestampSpan.textContent = '';
                
                if (responsibleInput) {
                    responsibleInput.style.display = 'none';
                    responsibleInput.value = ''; // Clear the value when unchecked
                }
                if (responsibleDisplay) {
                    responsibleDisplay.style.display = 'none';
                    if (responsibleNameSpan) responsibleNameSpan.textContent = '';
                }
            }
        }

        function saveTemperatures() {
            const date = document.getElementById('currentDate').textContent;
            const shift = document.getElementById('currentShift').textContent;
            const now = new Date();
            const currentTime = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            const data = {
                date: date,
                shift: shift,
                timestamp: currentTime, // Overall timestamp for the save action
                readings: []
            };

            const tempInputs = [
                { id: 'fridge', name: 'K√ºhlschrank Allgemein', min: 2, max: 7 },
                { id: 'freezer', name: 'Tiefk√ºhlung', min: -30, max: -18 },
                { id: 'warmer', name: 'Warmhaltung', min: 65, max: 100 },
                { id: 'serving', name: 'Speisen beim Servieren', min: null, max: null } 
            ];

            tempInputs.forEach(item => {
                const tempInput = document.getElementById(`${item.id}-temp`);
                const timeInput = document.getElementById(`${item.id}-time`);
                
                const temp = tempInput ? tempInput.value : '';
                const time = timeInput ? timeInput.value : '';
                const status = document.getElementById(`${item.id}-status`).textContent;
                let type = item.id === 'serving' ? document.getElementById('serving-type').value : null;

                if (temp) {
                    data.readings.push({
                        name: item.name,
                        value: parseFloat(temp),
                        time: time || currentTime, // Use input time if available, otherwise current time
                        status: status,
                        type: type 
                    });
                }
            });

            const action = document.getElementById('temp-action').value;
            const responsible = document.getElementById('temp-responsible').value;

            if (action || responsible) { // Save corrective action even if only one field is filled
                data.correctiveAction = { 
                    action: action || 'N/A', 
                    responsible: responsible || 'N/A' 
                };
            }

            tempReadings.push(data);
            localStorage.setItem('haccpTempReadings', JSON.stringify(tempReadings));
            alert('Temperaturen erfolgreich gespeichert!');
            updateProtocolTable();
            resetTemperatureForm();
        }

        function resetTemperatureForm() {
            document.getElementById('fridge-temp').value = '';
            document.getElementById('freezer-temp').value = '';
            document.getElementById('warmer-temp').value = '';
            document.getElementById('serving-temp').value = '';

            document.getElementById('fridge-time').value = '';
            document.getElementById('freezer-time').value = '';
            document.getElementById('warmer-time').value = '';
            document.getElementById('serving-time').value = '';

            document.getElementById('fridge-status').textContent = '-';
            document.getElementById('freezer-status').textContent = '-';
            document.getElementById('warmer-status').textContent = '-';
            document.getElementById('serving-status').textContent = '-';

            document.getElementById('fridge-status').className = 'temp-status';
            document.getElementById('freezer-status').className = 'temp-status';
            document.getElementById('warmer-status').className = 'temp-status critical'; 
            document.getElementById('serving-status').className = 'temp-status critical'; 

            document.getElementById('fridge-status').closest('.temp-card').classList.remove('critical', 'danger');
            document.getElementById('freezer-status').closest('.temp-card').classList.remove('critical', 'danger');
            document.getElementById('warmer-status').closest('.temp-card').classList.remove('danger');
            document.getElementById('serving-status').closest('.temp-card').classList.remove('danger');

            document.getElementById('temp-corrective').style.display = 'none';
            document.getElementById('temp-action').value = '';
            document.getElementById('temp-responsible').value = '';
        }

        function saveHygieneChecks() {
            const date = document.getElementById('currentDate').textContent;
            const shift = document.getElementById('currentShift').textContent;
            
            const checks = {};
            document.querySelectorAll('#hygiene .check-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const id = checkbox.id;
                const label = item.querySelector('label').textContent;
                const timestamp = item.querySelector('.timestamp').textContent;
                const responsibleInput = item.querySelector('.responsible-input');
                const responsible = responsibleInput ? responsibleInput.value : ''; 

                checks[id] = {
                    label: label,
                    checked: checkbox.checked,
                    timestamp: timestamp,
                    responsible: responsible 
                };
            });

            hygieneChecks[date + '_' + shift] = checks; 
            localStorage.setItem('haccpHygieneChecks', JSON.stringify(hygieneChecks));
            alert('Hygienechecks erfolgreich gespeichert!');
            updateProtocolTable();
            // Reset input fields for responsible after saving and hide them
            document.querySelectorAll('#hygiene .responsible-input').forEach(input => {
                input.value = '';
                input.style.display = 'none';
            });
            document.querySelectorAll('#hygiene .responsible-display').forEach(display => {
                display.style.display = 'none';
                display.querySelector('.responsible-name').textContent = '';
            });
        }

        function saveStorageChecks() {
            const date = document.getElementById('currentDate').textContent;
            const shift = document.getElementById('currentShift').textContent;
            
            const checks = {};
            document.querySelectorAll('#storage .check-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const id = checkbox.id;
                const label = item.querySelector('label').textContent;
                const timestamp = item.querySelector('.timestamp').textContent;
                const responsibleInput = item.querySelector('.responsible-input');
                const responsible = responsibleInput ? responsibleInput.value : ''; 

                checks[id] = {
                    label: label,
                    checked: checkbox.checked,
                    timestamp: timestamp,
                    responsible: responsible 
                };
            });
            checks['notes'] = document.getElementById('storage-notes').value;

            storageChecks[date + '_' + shift] = checks; 
            localStorage.setItem('haccpStorageChecks', JSON.stringify(storageChecks));
            alert('Lagerungschecks erfolgreich gespeichert!');
            updateProtocolTable();
            document.querySelectorAll('#storage .responsible-input').forEach(input => {
                input.value = '';
                input.style.display = 'none';
            });
            document.querySelectorAll('#storage .responsible-display').forEach(display => {
                display.style.display = 'none';
                display.querySelector('.responsible-name').textContent = '';
            });
        }

        function saveCleaningChecks() {
            const date = document.getElementById('currentDate').textContent;
            const shift = document.getElementById('currentShift').textContent;
            
            const checks = {};
            document.querySelectorAll('#cleaning .check-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const id = checkbox.id;
                const label = item.querySelector('label').textContent;
                const timestamp = item.querySelector('.timestamp').textContent;
                const responsibleInput = item.querySelector('.responsible-input');
                const responsible = responsibleInput ? responsibleInput.value : ''; 

                checks[id] = {
                    label: label,
                    checked: checkbox.checked,
                    timestamp: timestamp,
                    responsible: responsible 
                };
            });
            checks['notes'] = document.getElementById('cleaning-notes').value;

            cleaningChecks[date + '_' + shift] = checks; 
            localStorage.setItem('haccpCleaningChecks', JSON.stringify(cleaningChecks));
            alert('Reinigungschecks erfolgreich gespeichert!');
            updateProtocolTable();
            document.querySelectorAll('#cleaning .responsible-input').forEach(input => {
                input.value = '';
                input.style.display = 'none';
            });
            document.querySelectorAll('#cleaning .responsible-display').forEach(display => {
                display.style.display = 'none';
                display.querySelector('.responsible-name').textContent = '';
            });
        }

        function loadSavedData() {
            const savedTempReadings = localStorage.getItem('haccpTempReadings');
            if (savedTempReadings) {
                tempReadings = JSON.parse(savedTempReadings);
            }

            const date = document.getElementById('currentDate').textContent;
            const shift = document.getElementById('currentShift').textContent;

            // Load Hygiene Checks
            const savedHygieneChecks = localStorage.getItem('haccpHygieneChecks');
            if (savedHygieneChecks) {
                hygieneChecks = JSON.parse(savedHygieneChecks);
                const currentDayHygiene = hygieneChecks[date + '_' + shift];
                if (currentDayHygiene) {
                    for (const id in currentDayHygiene) {
                        const itemData = currentDayHygiene[id];
                        const checkbox = document.getElementById(id);
                        if (checkbox && itemData && itemData.checked !== undefined) {
                            checkbox.checked = itemData.checked;
                            const parent = checkbox.closest('.check-item');
                            const timestampSpan = parent.querySelector('.timestamp');
                            const responsibleInput = parent.querySelector('.responsible-input');
                            const responsibleDisplay = parent.querySelector('.responsible-display');
                            const responsibleNameSpan = responsibleDisplay ? responsibleDisplay.querySelector('.responsible-name') : null;

                            if (itemData.checked) {
                                parent.classList.add('completed');
                                timestampSpan.textContent = itemData.timestamp;
                                if (responsibleInput) responsibleInput.style.display = 'none';
                                if (responsibleDisplay && responsibleNameSpan) {
                                    responsibleNameSpan.textContent = itemData.responsible || '';
                                    responsibleDisplay.style.display = itemData.responsible ? 'inline-block' : 'none';
                                }
                            } else {
                                parent.classList.remove('completed');
                                timestampSpan.textContent = '';
                                if (responsibleInput) responsibleInput.style.display = 'none';
                                if (responsibleDisplay) responsibleDisplay.style.display = 'none';
                            }
                        }
                    }
                }
            }

            // Load Storage Checks
            const savedStorageChecks = localStorage.getItem('haccpStorageChecks');
            if (savedStorageChecks) {
                storageChecks = JSON.parse(savedStorageChecks);
                const currentDayStorage = storageChecks[date + '_' + shift];
                if (currentDayStorage) {
                    for (const id in currentDayStorage) {
                        const itemData = currentDayStorage[id];
                        if (id === 'notes') {
                            document.getElementById('storage-notes').value = itemData;
                        } else {
                            const checkbox = document.getElementById(id);
                            if (checkbox && itemData && itemData.checked !== undefined) {
                                checkbox.checked = itemData.checked;
                                const parent = checkbox.closest('.check-item');
                                const timestampSpan = parent.querySelector('.timestamp');
                                const responsibleInput = parent.querySelector('.responsible-input');
                                const responsibleDisplay = parent.querySelector('.responsible-display');
                                const responsibleNameSpan = responsibleDisplay ? responsibleDisplay.querySelector('.responsible-name') : null;

                                if (itemData.checked) {
                                    parent.classList.add('completed');
                                    timestampSpan.textContent = itemData.timestamp;
                                    if (responsibleInput) responsibleInput.style.display = 'none';
                                    if (responsibleDisplay && responsibleNameSpan) {
                                        responsibleNameSpan.textContent = itemData.responsible || '';
                                        responsibleDisplay.style.display = itemData.responsible ? 'inline-block' : 'none';
                                    }
                                } else {
                                    parent.classList.remove('completed');
                                    timestampSpan.textContent = '';
                                    if (responsibleInput) responsibleInput.style.display = 'none';
                                    if (responsibleDisplay) responsibleDisplay.style.display = 'none';
                                }
                            }
                        }
                    }
                }
            }

            // Load Cleaning Checks
            const savedCleaningChecks = localStorage.getItem('haccpCleaningChecks');
            if (savedCleaningChecks) {
                cleaningChecks = JSON.parse(savedCleaningChecks);
                const currentDayCleaning = cleaningChecks[date + '_' + shift];
                if (currentDayCleaning) {
                    for (const id in currentDayCleaning) {
                        const itemData = currentDayCleaning[id];
                        if (id === 'notes') {
                            document.getElementById('cleaning-notes').value = itemData;
                        } else {
                            const checkbox = document.getElementById(id);
                            if (checkbox && itemData && itemData.checked !== undefined) {
                                checkbox.checked = itemData.checked;
                                const parent = checkbox.closest('.check-item');
                                const timestampSpan = parent.querySelector('.timestamp');
                                const responsibleInput = parent.querySelector('.responsible-input');
                                const responsibleDisplay = parent.querySelector('.responsible-display');
                                const responsibleNameSpan = responsibleDisplay ? responsibleDisplay.querySelector('.responsible-name') : null;

                                if (itemData.checked) {
                                    parent.classList.add('completed');
                                    timestampSpan.textContent = itemData.timestamp;
                                    if (responsibleInput) responsibleInput.style.display = 'none';
                                    if (responsibleDisplay && responsibleNameSpan) {
                                        responsibleNameSpan.textContent = itemData.responsible || '';
                                        responsibleDisplay.style.display = itemData.responsible ? 'inline-block' : 'none';
                                    }
                                } else {
                                    parent.classList.remove('completed');
                                    timestampSpan.textContent = '';
                                    if (responsibleInput) responsibleInput.style.display = 'none';
                                    if (responsibleDisplay) responsibleDisplay.style.display = 'none';
                                }
                            }
                        }
                    }
                }
            }
            updateProtocolTable();
        }

        function updateProtocolTable() {
            const protocolBody = document.getElementById('protocol-body');
            protocolBody.innerHTML = ''; 

            let tempOk = 0;
            let tempWarning = 0;
            let tempCritical = 0;
            let hygieneCompleted = 0;

            // Process Temperature Readings
            // Sort by date and then by internal timestamp (if available, otherwise by save timestamp)
            tempReadings.sort((a, b) => {
                const dateA = new Date(a.date.replace(/(\d+)\. (\w+) (\d+)/, '$2 $1, $3')); // Convert "24. Juni 2025" to "June 24, 2025"
                const dateB = new Date(b.date.replace(/(\d+)\. (\w+) (\d+)/, '$2 $1, $3'));
                if (dateA.getTime() === dateB.getTime()) {
                    // If dates are the same, sort by the overall save timestamp
                    const timeA = a.timestamp || '00:00';
                    const timeB = b.timestamp || '00:00';
                    return timeA.localeCompare(timeB);
                }
                return dateA - dateB;
            }).slice().reverse().forEach(entry => { // Show most recent first
                const dateShift = `${entry.date} (${entry.shift})`;
                
                // Add a main entry for the temperature save action
                const mainRow = protocolBody.insertRow();
                mainRow.insertCell().textContent = dateShift + ' ' + (entry.timestamp || '');
                mainRow.insertCell().textContent = 'Temperaturkontrolle';
                mainRow.insertCell().textContent = ''; // No specific value for the overall entry
                mainRow.insertCell().textContent = 'Gespeichert';
                mainRow.insertCell().textContent = entry.correctiveAction ? entry.correctiveAction.action : 'N/A';
                mainRow.insertCell().textContent = entry.correctiveAction ? entry.correctiveAction.responsible : 'N/A';
                mainRow.style.fontWeight = 'bold';
                mainRow.style.backgroundColor = '#eef'; // Light blue background

                entry.readings.forEach(reading => {
                    const row = protocolBody.insertRow();
                    row.insertCell().textContent = '‚Ü≥ ' + reading.time; // Indent for sub-entry
                    row.insertCell().textContent = reading.name;
                    row.insertCell().textContent = `${reading.value}¬∞C` + (reading.type ? ` (${reading.type})` : '');
                    row.insertCell().textContent = reading.status;
                    row.insertCell().textContent = ''; // Measures and responsible are for the overall entry
                    row.insertCell().textContent = '';

                    if (reading.status === 'OK') {
                        tempOk++;
                    } else if (reading.status.includes('Warnung')) {
                        tempWarning++;
                    } else if (reading.status.includes('Kritisch')) {
                        tempCritical++;
                    }
                });
            });

            // Process Hygiene, Storage, Cleaning Checks
            // Collect all checklist entries and sort them
            let allChecklistEntries = [];

            for (const key in hygieneChecks) {
                const [date, shift] = key.split('_');
                const checks = hygieneChecks[key];
                for (const id in checks) {
                    const check = checks[id];
                    if (check.checked) {
                        hygieneCompleted++;
                        allChecklistEntries.push({
                            date: date,
                            shift: shift,
                            time: check.timestamp.replace('Erledigt um: ', ''),
                            area: 'Hygiene',
                            item: check.label,
                            status: 'Erledigt',
                            action: 'N/A',
                            responsible: check.responsible || 'N/A'
                        });
                    }
                }
            }

            for (const key in storageChecks) {
                const [date, shift] = key.split('_');
                const checks = storageChecks[key];
                if (checks['notes']) {
                    allChecklistEntries.push({
                        date: date,
                        shift: shift,
                        time: '', // No specific time for notes
                        area: 'Lagerung',
                        item: 'Bemerkungen',
                        status: 'Dokumentiert',
                        action: checks['notes'],
                        responsible: 'N/A' // Notes typically don't have a specific responsible
                    });
                }
                for (const id in checks) {
                    if (id !== 'notes' && checks[id].checked) {
                        const check = checks[id];
                        allChecklistEntries.push({
                            date: date,
                            shift: shift,
                            time: check.timestamp.replace('Erledigt um: ', ''),
                            area: 'Lagerung',
                            item: check.label,
                            status: 'Erledigt',
                            action: 'N/A',
                            responsible: check.responsible || 'N/A'
                        });
                    }
                }
            }

            for (const key in cleaningChecks) {
                const [date, shift] = key.split('_');
                const checks = cleaningChecks[key];
                if (checks['notes']) {
                    allChecklistEntries.push({
                        date: date,
                        shift: shift,
                        time: '', // No specific time for notes
                        area: 'Reinigung',
                        item: 'Bemerkungen',
                        status: 'Dokumentiert',
                        action: checks['notes'],
                        responsible: 'N/A' // Notes typically don't have a specific responsible
                    });
                }
                for (const id in checks) {
                    if (id !== 'notes' && checks[id].checked) {
                        const check = checks[id];
                        allChecklistEntries.push({
                            date: date,
                            shift: shift,
                            time: check.timestamp.replace('Erledigt um: ', ''),
                            area: 'Reinigung',
                            item: check.label,
                            status: 'Erledigt',
                            action: 'N/A',
                            responsible: check.responsible || 'N/A'
                        });
                    }
                }
            }

            // Sort all checklist entries by date and then time
            allChecklistEntries.sort((a, b) => {
                const dateA = new Date(a.date.replace(/(\d+)\. (\w+) (\d+)/, '$2 $1, $3'));
                const dateB = new Date(b.date.replace(/(\d+)\. (\w+) (\d+)/, '$2 $1, $3'));
                if (dateA.getTime() === dateB.getTime()) {
                    const timeA = a.time || '00:00';
                    const timeB = b.time || '00:00';
                    return timeA.localeCompare(timeB);
                }
                return dateA - dateB;
            });
            
            // Add sorted checklist entries to the table
            allChecklistEntries.slice().reverse().forEach(entry => { // Display most recent first
                const row = protocolBody.insertRow();
                row.insertCell().textContent = `${entry.date} (${entry.shift}) ${entry.time}`;
                row.insertCell().textContent = entry.area;
                row.insertCell().textContent = entry.item;
                row.insertCell().textContent = entry.status;
                row.insertCell().textContent = entry.action;
                row.insertCell().textContent = entry.responsible;
            });

            // Update Summary Stats
            document.getElementById('temp-ok-count').textContent = tempOk;
            document.getElementById('temp-warning-count').textContent = tempWarning;
            document.getElementById('temp-critical-count').textContent = tempCritical;
            document.getElementById('hygiene-completed-count').textContent = hygieneCompleted;
        }

        function printDailyProtocol() {
            const protocolCardContent = document.querySelector('#protocols .card').innerHTML; // Get only the content of the card
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>HACCP Tagesprotokoll</title>');
            // Copy relevant styles for printing
            printWindow.document.write('<style>');
            printWindow.document.write(document.querySelector('style').innerHTML); // Copy all CSS from the main document
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            
            // Add a clean header for the printout
            printWindow.document.write(`
                <div class="header" style="background: #e74c3c; color: white; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 10px;">
                    <h1 style="font-size: 2em; margin-bottom: 10px;">üõ°Ô∏è HACCP Tagesprotokoll</h1>
                    <p style="font-size: 1.1em; opacity: 0.9;"><strong>Datum:</strong> ${document.getElementById('currentDate').textContent} | <strong>Schicht:</strong> ${document.getElementById('currentShift').textContent}</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">K√ºchenhygiene Pflegeheim</p>
                </div>
            `);

            // Add only the content of the protocols card
            printWindow.document.write('<div class="container" style="max-width: 1000px; margin: 0 auto; padding: 0;">'); // Simplified container for print
            printWindow.document.write('<div class="card" style="box-shadow: none; border: none; padding: 0;">'); // Remove card styling for print
            printWindow.document.write(protocolCardContent);
            printWindow.document.write('</div>');
            printWindow.document.write('</div>');

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();

            // Give a small delay for content to render before printing
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500); 
        }

    </script>
</body>
</html>
